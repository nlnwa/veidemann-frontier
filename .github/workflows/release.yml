# This workflow will build the Java project with Maven, create a container and publish it to GitHub Container Registry.

name: Release

on:
  push:
    # Publish `main` as Docker `latest` image.
    branches:
      - main

    # Publish `v1.2.3` tags as releases.
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

jobs:
  release:
    name: Build and publish docker image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'
          server-id: ghcr.io

      - name: Build and publish docker image
        run: |
          # Strip git ref prefix from version
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          # Strip "v" prefix from tag name
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          # Use Docker `latest` tag convention
          [ "$VERSION" == "main" ] && VERSION=latest
          echo VERSION=$VERSION
          ./mvnw -B -Ddocker.tag="$VERSION" package jib:build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
